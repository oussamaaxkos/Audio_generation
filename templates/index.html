<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stylish Chat Bot Interface</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: white;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .container {
            text-align: center;
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

        .orb {
            position: relative;
            width: 200px;
            height: 200px;
            margin: auto;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 100px rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            cursor: pointer;
        }

        .wave {
            position: absolute;
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            transform-origin: center;
            animation-name: pulse, morph;
        }
        
        @keyframes morph {
            0% { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
            25% { border-radius: 40% 60% 60% 40% / 60% 30% 70% 40%; }
            50% { border-radius: 40% 60% 30% 70% / 50% 60% 30% 60%; }
            75% { border-radius: 30% 70% 70% 30% / 50% 40% 60% 50%; }
            100% { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
        }

        .wave1 {
            width: 140px;
            height: 140px;
            background: radial-gradient(circle, rgba(13, 111, 255, 0.7) 0%, rgba(0, 204, 255, 0) 70%);
            animation: pulse 3s infinite ease-in-out, morph 8s infinite ease-in-out;
        }

        .wave2 {
            width: 160px;
            height: 160px;
            background: radial-gradient(circle, rgba(255, 0, 89, 0.5) 0%, rgba(255, 0, 0, 0) 70%);
            animation: pulse 3s infinite ease-in-out 0.5s, morph 7s infinite ease-in-out 0.5s;
        }

        .wave3 {
            width: 180px;
            height: 180px;
            background: radial-gradient(circle, rgba(0, 255, 170, 0.6) 0%, rgba(0, 255, 0, 0) 70%);
            animation: pulse 3s infinite ease-in-out 1s, morph 9s infinite ease-in-out 1s;
        }

        .center-glow {
            position: absolute;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0));
            border-radius: 30% 70% 50% 50% / 50% 40% 60% 50%;
            animation: breathe 3s infinite ease-in-out, morph 5s infinite ease-in-out;
        }
        
        .noise {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.05;
            mix-blend-mode: overlay;
            pointer-events: none;
        }

        .chat-input {
            position: relative;
            width: 80%;
            max-width: 600px;
            height: 60px;
            margin-bottom: 100px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .chat-input input {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            font-size: 18px;
            outline: none;
        }

        .input-icon {
            position: absolute;
            width: 20px;
            height: 20px;
            right: 20px;
            background-color: #0a84ff;
            border-radius: 50%;
            animation: breathe 1.5s infinite ease-in-out;
        }

        .header {
            width: 100%;
            padding: 20px 0;
            text-align: center;
            font-size: 22px;
            font-weight: 300;
            margin-top: 40px;
        }

        .options-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 40px;
            width: 80%;
            max-width: 700px;
        }

        .option-button {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            border: none;
            color: white;
        }

        .option-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        @keyframes pulse {
            0% {
                transform: scale(0.8);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.9;
            }
            100% {
                transform: scale(0.8);
                opacity: 0.7;
            }
        }

        @keyframes breathe {
            0% {
                opacity: 0.5;
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            }
            50% {
                opacity: 1;
                box-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
            }
            100% {
                opacity: 0.5;
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            }
        }

        .response {
            text-align: center;
            font-size: 20px;
            font-weight: 300;
            max-width: 80%;
            margin: 20px 0;
            min-height: 30px;
        }
        
        .chat-messages {
            width: 80%;
            max-width: 700px;
            max-height: 250px;
            overflow-y: auto;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        
        .message {
            padding: 12px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            margin: 4px 0;
        }
        
        .bot-message {
            background-color: rgba(13, 111, 255, 0.3);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        .user-message {
            background-color: rgba(0, 255, 170, 0.2);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        .feature-interface {
            margin-top: 15px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            display: none;
            width: 80%;
            max-width: 600px;
        }
        
        .music-interface {
            text-align: center;
        }
        
        .music-interface label {
            display: block;
            margin-bottom: 15px;
            font-weight: 300;
            font-size: 18px;
        }
        
        .music-interface input[type="file"] {
            display: none;
        }
        
        .custom-file-upload {
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: inline-block;
            padding: 12px 30px;
            cursor: pointer;
            border-radius: 25px;
            background-color: rgba(13, 111, 255, 0.2);
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .custom-file-upload:hover {
            background-color: rgba(13, 111, 255, 0.4);
        }
        
        .process-button {
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: inline-block;
            padding: 12px 30px;
            cursor: pointer;
            border-radius: 25px;
            background-color: rgba(0, 255, 170, 0.2);
            transition: all 0.3s ease;
            margin-top: 15px;
            display: none;
        }
        
        .process-button:hover {
            background-color: rgba(0, 255, 170, 0.4);
        }

        .file-name {
            margin-top: 10px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .status-container {
            margin-top: 20px;
            display: none;
        }
        
        .status-message {
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress {
            height: 100%;
            background-color: rgba(0, 255, 170, 0.6);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .stems-container {
            margin-top: 20px;
            display: none;
        }
        
        .stems-title {
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .stem-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .stem-name-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stem-icon {
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
        }

        .stem-icon.vocals {
            background-color: rgba(255, 64, 129, 0.3);
        }

        .stem-icon.drums {
            background-color: rgba(255, 160, 0, 0.3);
        }

        .stem-icon.bass {
            background-color: rgba(0, 200, 83, 0.3);
        }
        
        .stem-icon.other {
            background-color: rgba(33, 150, 243, 0.3);
        }
        
        .stem-name {
            font-size: 16px;
        }
        
        .stem-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stem-play {
            background-color: rgba(0, 255, 170, 0.3);
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stem-play:hover {
            background-color: rgba(0, 255, 170, 0.5);
        }
        
        .stem-download {
            background-color: rgba(13, 111, 255, 0.3);
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stem-download:hover {
            background-color: rgba(13, 111, 255, 0.5);
        }
        
        .audio-player {
            margin-top: 20px;
            width: 100%;
            display: none;
        }
        
        .audio-player audio {
            width: 100%;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .custom-audio-player {
            margin-top: 20px;
            width: 100%;
            display: none;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
        }
        
        .audio-title {
            font-size: 14px;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .audio-play-pause {
            background-color: rgba(0, 255, 170, 0.3);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .audio-play-pause:hover {
            background-color: rgba(0, 255, 170, 0.5);
        }
        
        .audio-progress-container {
            flex-grow: 1;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }
        
        .audio-progress-bar {
            height: 100%;
            background-color: rgba(0, 255, 170, 0.6);
            width: 0%;
            border-radius: 4px;
            transition: width 0.1s linear;
        }
        
        .audio-time {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            min-width: 80px;
            text-align: right;
        }
        
        .ai-agent-interface {
            text-align: center;
        }
        
        .ai-agent-interface h3 {
            font-weight: 300;
            margin-bottom: 15px;
        }

        .voice-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            gap: 15px;
        }

        .mic-button {
            background-color: rgba(0, 255, 170, 0.3);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .mic-button:hover {
            background-color: rgba(0, 255, 170, 0.5);
        }

        .mic-button.listening {
            background-color: rgba(255, 64, 129, 0.5);
            animation: pulse 1.5s infinite ease-in-out;
        }

        .status-text {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            height: 20px;
        }

        .recognition-text {
            margin-top: 20px;
            font-size: 18px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            min-height: 50px;
            width: 100%;
            display: none;
        }

        .map-container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        #map {
            width: 100%;
            height: 400px;
            border-radius: 10px;
            margin-top: 15px;
        }


        /* ////////////////////////////////////////////// */


        .outputs-container {
    max-width: 1200px;
    width: 100%;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 30px;
    max-height: 90vh;
    overflow-y: auto;
}

.output-card {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border-radius: 16px;
    padding: 25px;
    border: 1px solid #333;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.output-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
}

.output-card h3 {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 20px;
    color: #ffffff;
    text-align: center;
    padding-bottom: 15px;
    border-bottom: 2px solid #444;
}

.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.card {
    background: linear-gradient(145deg, #252525, #1a1a1a);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #404040;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.card:hover {
    transform: translateY(-3px);
    border-color: #555;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.card:hover::before {
    opacity: 1;
}

.audio-item {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.audio-item strong {
    font-size: 16px;
    font-weight: 600;
    color: #e0e0e0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

audio {
    width: 100%;
    height: 40px;
    border-radius: 8px;
    background: #1a1a1a;
    outline: none;
}

audio::-webkit-media-controls-panel {
    background-color: #1a1a1a;
    border-radius: 8px;
}

audio::-webkit-media-controls-play-button,
audio::-webkit-media-controls-pause-button {
    background-color: #667eea;
    border-radius: 50%;
}

audio::-webkit-media-controls-timeline {
    background-color: #333;
    border-radius: 4px;
}

audio::-webkit-media-controls-current-time-display,
audio::-webkit-media-controls-time-remaining-display {
    color: #e0e0e0;
}

.no-results {
    text-align: center;
    font-size: 18px;
    color: #888;
    padding: 40px;
}

/* Scrollbar styling */
.outputs-container::-webkit-scrollbar {
    width: 8px;
}

.outputs-container::-webkit-scrollbar-track {
    background: #1a1a1a;
    border-radius: 4px;
}

.outputs-container::-webkit-scrollbar-thumb {
    background: #444;
    border-radius: 4px;
}

.outputs-container::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Responsive design */
@media (max-width: 768px) {
    .outputs-container {
        padding: 15px;
    }

    .output-card {
        padding: 20px;
    }

    .cards-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .output-card h3 {
        font-size: 20px;
    }
}
    </style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
      crossorigin="anonymous"/>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">

<h2>Audioia</h2>
<img src="../static/images/logo.png" style="max-width: 100px;" alt="">





      <div class="header">What would you like me to help you with today?</div>
  
      <div class="chat-messages" id="chatMessages"></div>
  
      <div class="orb" id="orb" style="display: none;">
        <div class="wave wave1"></div>
        <div class="wave wave2"></div>
        <div class="wave wave3"></div>
        <div class="center-glow"></div>
        <div class="noise" id="noise"></div>
      </div>
  
      <div class="response" id="responseText"></div>
  
      <div class="options-container">
        <button class="option-button" onclick="showFeature('music')">Separate Music</button>
        <button class="option-button" onclick="showFeature('ai')">AI Agent</button>
        <button class="option-button" onclick="clearChat()">Clear Chat</button>
      </div>
  
      <div class="feature-interface" id="musicInterface">
        <div class="music-interface">
          <label for="musicUpload">Upload your music file:</label>
          <input type="file" id="musicUpload" accept="audio/*" onchange="handleFileUpload(this)" />
          <label for="musicUpload" class="custom-file-upload">Choose File</label>
          <div id="fileName" class="file-name"></div>
          <button id="processButton" class="process-button" onclick="processAudio()">Start Processing</button>
          
          <div id="statusContainer" class="status-container">
            <div id="statusMessage" class="status-message">Processing...</div>
            <div class="progress-bar">
              <div id="progressBar" class="progress"></div>
            </div>
          </div>
          
          <div id="stemsContainer" class="stems-container">
            <div class="stems-title">Separated Stems:</div>
            <div id="stemsList"></div>
            <div id="audioPlayerContainer" class="audio-player">
              <audio id="audioPlayer" controls></audio>
            </div>
          </div>
        </div>
      </div>
  
      <div class="feature-interface" id="aiAgentInterface">
        <div class="ai-agent-interface">
          <h3>Voice Assistant</h3>
          <p>Click the microphone button and speak your command</p>

          <div class="voice-controls">
            <button class="mic-button" id="micButton">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
              </svg>
            </button>
            <div class="status-text" id="statusText">Click to activate voice assistant</div>
          </div>
          <div class="recognition-text" id="recognitionText"></div>
        </div>
      </div>
      <div class="chat-input" style="background-color: black;">
       
      </div>
  
      <div class="chat-input" style="display: none;">
        <input type="text" id="userInput" placeholder="Type your message..." onkeydown="handleKey(event)" />
        <div class="input-icon"></div>
      </div>
    </div>
  
    <!-- {% if location %} -->
    <div id="map-container" style="display: none;" class="map-container">
        <h2 id="location-title">Location information will appear here</h2>
        <div id="map" style="height: 400px; width: 100%; border-radius: 8px;"></div>
    </div>


<!-- {% if outputs %}
<div class="outputs-container">
    {% for output in outputs %}
    {% set folder_name = output.s.split('\\')[-1] %}
    <div class="output-card">
        <h3>{{ folder_name }}</h3>
        <div class="cards-grid">
            {% for stem in ['bass', 'drums', 'other', 'vocals'] %}
            <div class="card">
                <div class="audio-item">
                    <strong>{{ stem.capitalize() }}</strong>
                    <audio controls>
                        <source src="../outputs/124027f8-a9af-420b-a307-e62c715995dc/bass.wav" type="audio/wav">
                        Votre navigateur ne supporte pas l'élément audio.
                    </audio>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p class="no-results">Aucun résultat trouvé.</p>
{% endif %} -->


    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // var map = L.map('map').setView([0, 0], 2);

        // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        //     maxZoom: 19,
        //     attribution: '© OpenStreetMap'
        // }).addTo(map);

        // var mapDiv = document.getElementById('map');
        // var lat = parseFloat(mapDiv.dataset.lat);
        // var lon = parseFloat(mapDiv.dataset.lon);
        // var city = mapDiv.dataset.city;
        // var country = mapDiv.dataset.country;

        // setTimeout(function () {
        //     map.flyTo([lat, lon], 13, {
        //         animate: true,
        //         duration: 2
        //     });

        //     L.marker([lat, lon]).addTo(map)
        //         .bindPopup("You are here: " + city + ", " + country)
        //         .openPopup();
        // }, 1000);


        document.getElementById('statusText').textContent = "Voice assistant is active, try saying 'Where am I?'";
    </script>
    <!-- {% endif %} -->


    <script>
      const chatMessages = document.getElementById('chatMessages');
      const userInput = document.getElementById('userInput');
      const responseText = document.getElementById('responseText');
      const orb = document.getElementById('orb');
      const musicInterface = document.getElementById('musicInterface');
      const aiAgentInterface = document.getElementById('aiAgentInterface');
      const processButton = document.getElementById('processButton');
      const fileName = document.getElementById('fileName');
      const statusContainer = document.getElementById('statusContainer');
      const statusMessage = document.getElementById('statusMessage');
      const progressBar = document.getElementById('progressBar');
      const stemsContainer = document.getElementById('stemsContainer');
      const stemsList = document.getElementById('stemsList');
      const micButton = document.getElementById('micButton');
      const statusText = document.getElementById('statusText');
      const recognitionText = document.getElementById('recognitionText');
      
      let selectedFile = null;
      let currentJobId = null;
      let voiceAssistantActive = false;
      let isListening = false;
      
      function handleKey(event) {
        if (event.key === 'Enter') {
          sendMessage();
        }
      }

      function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;
        addMessage(message, 'user');
        userInput.value = '';
        simulateBotResponse(message);
      }
  
      function addMessage(text, sender) {
        const msg = document.createElement('div');
        msg.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
        msg.innerText = text;
        chatMessages.appendChild(msg);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
  
      function simulateBotResponse(input) {
        orb.style.display = 'flex';
        responseText.textContent = "Thinking...";
  
        setTimeout(() => {
          let reply = "I'm here to help!";
          if (input.toLowerCase().includes("music")) {
            reply = "Sure! Upload your favorite track below.";
            showFeature('music');
          } else if (input.toLowerCase().includes("ai") || input.toLowerCase().includes("voice")) {
            reply = "Voice Assistant is ready. Click the microphone button to start.";
            showFeature('ai');
          }
          addMessage(reply, 'bot');
          responseText.textContent = '';
          orb.style.display = 'none';
        }, 1000);
      }
  
      function showFeature(type) {
        musicInterface.style.display = 'none';
        aiAgentInterface.style.display = 'none';

        if (type === 'music') {
            musicInterface.style.display = 'block';
            orb.style.display = 'none'; // hide orb for music
        } else if (type === 'ai') {
            aiAgentInterface.style.display = 'block';
            orb.style.display = 'flex'; // show orb permanently for AI
            startVoiceAssistant();
        }
      }
      
      function handleFileUpload(input) {
        if (input.files && input.files[0]) {
          selectedFile = input.files[0];
          fileName.textContent = selectedFile.name;
          processButton.style.display = 'inline-block';
          statusContainer.style.display = 'none';
          stemsContainer.style.display = 'none';
        }
      }
      
      function processAudio() {
        if (!selectedFile) {
          alert("Please select a file first");
          return;
        }
        
        // Show processing status
        statusContainer.style.display = 'block';
        statusMessage.textContent = "Uploading...";
        progressBar.style.width = "10%";
        processButton.style.display = 'none';
        
        // Create form data
        const formData = new FormData();
        formData.append('file', selectedFile);
        
        // Send to API
        fetch('/upload', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.job_id) {
            currentJobId = data.job_id;
            statusMessage.textContent = "Processing audio...";
            progressBar.style.width = "30%";
            
            // Start polling for status
            pollJobStatus(currentJobId);
          } else {
            throw new Error(data.error || "Upload failed");
          }
        })
        .catch(error => {
          statusMessage.textContent = "Error: " + error.message;
          processButton.style.display = 'inline-block';
        });
      }
      
      function pollJobStatus(jobId) {
        const checkStatus = () => {
          fetch(`/status/${jobId}`)
            .then(response => response.json())
            .then(data => {
              if (data.status === 'completed') {
                // Processing complete
                progressBar.style.width = "100%";
                statusMessage.textContent = "Processing complete!";
                displayResults(data.results);
              } else if (data.status === 'failed') {
                // Processing failed
                statusMessage.textContent = "Processing failed: " + (data.error || "Unknown error");
                processButton.style.display = 'inline-block';
              } else {
                // Still processing
                progressBar.style.width = "60%";
                setTimeout(checkStatus, 3000); // Check again in 3 seconds
              }
            })
            .catch(error => {
              statusMessage.textContent = "Error checking status: " + error.message;
              processButton.style.display = 'inline-block';
            });
        };
        
        // Start polling
        setTimeout(checkStatus, 2000);
      }
      
      function displayResults(results) {
        stemsContainer.style.display = 'block';
        stemsList.innerHTML = '';
        const audioPlayer = document.getElementById('audioPlayer');
        const audioPlayerContainer = document.getElementById('audioPlayerContainer');
        
        // Create stem items
        for (const [stemName, stemUrl] of Object.entries(results)) {
          const stemItem = document.createElement('div');
          stemItem.className = 'stem-item';
          
          // Name container with icon
          const nameContainer = document.createElement('div');
          nameContainer.className = 'stem-name-container';
          
          // Add appropriate icon based on stem type
          const iconSpan = document.createElement('span');
          iconSpan.className = `stem-icon ${stemName.toLowerCase()}`;
          
          // Add icon content based on stem type
          let iconContent = '';
          switch(stemName.toLowerCase()) {
            case 'vocals':
              iconContent = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>';
              break;
            case 'drums':
              iconContent = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle></svg>';
              break;
            case 'bass':
              iconContent = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M8 18V6l10 6-10 6z"></path></svg>';
              break;
            default:
              iconContent = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>';
          }
          iconSpan.innerHTML = iconContent;
          
          const nameSpan = document.createElement('span');
          nameSpan.className = 'stem-name';
          nameSpan.textContent = stemName;
          
          nameContainer.appendChild(iconSpan);
          nameContainer.appendChild(nameSpan);
          
          // Controls container
          const controlsDiv = document.createElement('div');
          controlsDiv.className = 'stem-controls';
          
          const playButton = document.createElement('span');
          playButton.className = 'stem-play';
          playButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M5 3l14 9-14 9V3z"></path></svg>';
          playButton.addEventListener('click', () => playStem(stemUrl));
          
          const downloadButton = document.createElement('span');
          downloadButton.className = 'stem-download';
          downloadButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 3v12M6 12l6 6 6-6"></path></svg>';
          downloadButton.addEventListener('click', () => downloadStem(stemUrl, stemName));
          
          controlsDiv.appendChild(playButton);
          controlsDiv.appendChild(downloadButton);
          
          stemItem.appendChild(nameContainer);
          stemItem.appendChild(controlsDiv);
          
          stemsList.appendChild(stemItem);
        }
      }
  
      function playStem(url) {
        const audioPlayer = document.getElementById('audioPlayer');
        audioPlayer.src = url;
        audioPlayer.play();
      }
  
      function downloadStem(url, name) {
        const a = document.createElement('a');
        a.href = url;
        a.download = `${name}.mp3`;
        a.click();
      }
      
      function startVoiceAssistant() {
            if (voiceAssistantActive) return;
            voiceAssistantActive = true;
            
            micButton.addEventListener('click', () => {
                // Call Flask API to start voice assistant
                fetch('/start_voice_assistant')
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);  // You can use this message to show a UI notification
                        recognition.start();  // Start the recognition if the assistant is running
                    })
                    .catch(error => console.error("Error starting voice assistant:", error));
            });
        }


        let map = null;
        let locationMarker = null;
        let isMapInitialized = false;

        // Function to initialize or update the map
        function initOrUpdateMap(lat, lon, city, country) {
        const mapContainer = document.getElementById('map-container');
        
        // If map container doesn't exist yet, create it
        if (!mapContainer) {
            // Create map container div
            const newMapContainer = document.createElement('div');
            newMapContainer.id = 'map-container';
            newMapContainer.className = 'map-container';
            
            // Create title element
            const mapTitle = document.createElement('h2');
            mapTitle.id = 'location-title';
            mapTitle.textContent = `You are in ${city}, ${country}`;
            
            // Create map div
            const mapDiv = document.createElement('div');
            mapDiv.id = 'map';
            mapDiv.style.height = '400px';
            mapDiv.style.width = '100%';
            
            // Add elements to container
            newMapContainer.appendChild(mapTitle);
            newMapContainer.appendChild(mapDiv);
            
            // Add container to page (after AI agent interface)
            const aiInterface = document.getElementById('aiAgentInterface');
            aiInterface.parentNode.insertBefore(newMapContainer, aiInterface.nextSibling);
            
            // Initialize map
            setTimeout(() => {
            map = L.map('map').setView([lat, lon], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap'
            }).addTo(map);
            
            // Add marker
            locationMarker = L.marker([lat, lon]).addTo(map)
                .bindPopup(`You are here: ${city}, ${country}`)
                .openPopup();
                
            isMapInitialized = true;
            mapContainer.style.display = 'block';
            }, 300);
        } 
        // If map exists, just update it
        else if (isMapInitialized) {
            document.getElementById('location-title').textContent = `You are in ${city}, ${country}`;
            map.flyTo([lat, lon], 13, { animate: true, duration: 1.5 });
            
            // Update marker
            if (locationMarker) {
            locationMarker.setLatLng([lat, lon]);
            locationMarker.setPopupContent(`You are here: ${city}, ${country}`);
            locationMarker.openPopup();
            } else {
            locationMarker = L.marker([lat, lon]).addTo(map)
                .bindPopup(`You are here: ${city}, ${country}`)
                .openPopup();
            }
            
            // Make sure map is visible
            mapContainer.style.display = 'block';
        }
        }

        // Function to check for location updates
        function pollForLocationUpdates() {
        fetch('/get_current_location')
            .then(response => response.json())
            .then(data => {
            // Only update the map if location data exists (has been requested by voice)
            if (data.latitude && data.longitude) {
                initOrUpdateMap(
                data.latitude, 
                data.longitude,
                data.city, 
                data.country
                );
            }
            })
            .catch(error => console.error("Error fetching location:", error));
        }

        // Function to start location polling when the voice assistant is activated
        function activateLocationPolling() {
        // Poll for location changes every 3 seconds
        setInterval(pollForLocationUpdates, 3000);
        }

        // Modify the startVoiceAssistant function to also activate location polling
        function startVoiceAssistant() {
        if (voiceAssistantActive) return;
        voiceAssistantActive = true;
        
        // Start location polling when the voice assistant is activated
        activateLocationPolling();
        
        micButton.addEventListener('click', () => {
            // Call Flask API to start voice assistant
            fetch('/start_voice_assistant')
            .then(response => response.json())
            .then(data => {
                console.log(data.message);
                recognition.start();
            })
            .catch(error => console.error("Error starting voice assistant:", error));
        });
        }
    </script>

</body>
</html>